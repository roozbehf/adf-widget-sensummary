!function(e,t){"use strict";angular.module("adf.widget.sensummary",["adf.provider"]).config(["dashboardProvider",function(e){e.widget("sensummary",{title:"Sensummary",description:"Summary of Sensu Check Reports",templateUrl:"{widgetsPath}/sensummary/src/view.html",reload:!0,edit:{templateUrl:"{widgetsPath}/sensummary/src/edit.html"},config:{},controller:"sensummaryCtrl",controllerAs:"swc"})}]),angular.module("adf.widget.sensummary").run(["$templateCache",function(e){e.put("{widgetsPath}/sensummary/src/edit.html","<form role=form><div class=form-group><label for=sensuAPI>Sensu API URL</label> <input type=text class=form-control id=sensuAPI ng-model=config.senserver></div><div class=form-group><label for=uchiwaURL>Uchiwa front URL (for the datacenter)</label> <input type=text class=form-control id=uchiwaURL ng-model=config.uchiwa_url></div></form>"),e.put("{widgetsPath}/sensummary/src/view.html",'<div><div class="alert alert-info" ng-if=!data>Please point the widget to a Sensu server in the configuration.</div><div ng-if=data><sensu-nodes data=data></sensu-nodes></div></div>')}]),angular.module("adf.widget.sensummary").directive("sensuNodes",["$window","$timeout","$interval",function(t,n,s){return{restrict:"E",scope:{data:"=",senserver:"=",label:"@",onClick:"&"},link:function(n,s,a){var r,o,i,l,c,u=30;t.onresize=function(){n.$apply()},n.$watch(function(){return angular.element(t)[0].innerWidth},function(){n.render(n.data)}),n.$watch("data",function(e){n.render(e)},!0),n.render=function(t){if(t){r||(o=1.7*Math.sqrt(u*u*n.data.nodes.length),i=o,l=o,c=i,r=d3.select(s[0]).append("svg").attr("width","100%").attr("height","100%").attr("class","bubble")),r.selectAll("*").remove();var a=d3.layout.force().nodes(d3.values(t.nodes)).gravity(.5).distance(30).charge(-7*u).size([l,c]).start();a.linkDistance(l/2);var d=r.selectAll(".node").data(t.nodes).enter().append("g").attr("class","node").call(a.drag),m=function(e){var t;switch(e.status){case 0:t="<span style='color: green' class='glyphicon glyphicon-ok-sign'></span>";break;case 1:t="<span style='color: yellow' class='glyphicon glyphicon-exclamation-sign'></span>";break;case 2:t="<span style='color: red' class='glyphicon glyphicon-remove-sign'></span>";break;default:t="<span class='glyphicon glyphicon-question-sign'></span>"}return t+" "+e.name+"<br><span style='color: #888888' class='glyphicon glyphicon-refresh'></span> <span class='updatetime'>updated "+e.lastUpdate+"</span>"},g=d3.tip().attr("class","d3-tip").offset([-10,0]).html(m);d.call(g);var f=function(e){switch(e.status){case 0:return"src/img/circle-green.svg";case 1:return"src/img/circle-yellow.svg";case 2:return"src/img/circle-red.svg";default:return"src/img/circle-grey.svg"}};d.append("image").attr("xlink:href",f).attr("x",-12).attr("y",-12).attr("width",u).attr("height",u).on("mouseover",g.show).on("mouseout",g.hide).on("dblclick",function(t){null!=t.url&&e.open(t.url,"_blank")}),a.on("tick",function(){d.attr("transform",function(e){return"translate("+e.x+", "+e.y+")"})})}}}}}]),angular.module("adf.widget.sensummary").controller("sensummaryCtrl",["$scope","$http","config",function(e,t,n,s){var a={nodes:[]};e.senserver=n.senserver,e.uchiwa_url=n.uchiwa_url,e.sensuConfig=!0;var r=function(){console.log("got here"),e.data=a,console.log("All node data is loaded."),e.$apply()},o=new Promise(function(n,s){e.senserver?t.get(e.senserver+"/clients").success(function(t){for(var s in t){var r=t[s].name,o={name:r,status:-1,url:e.uchiwa_url?e.uchiwa_url+"/"+r:null,lastUpdate:"few seconds ago"};a.nodes.push(o)}n(),console.log("Fetched the node list.")}):s("The sensummary widget is not configured yet.")}),i=function(){return new Promise(function(n,s){var r=[];for(var o in a.nodes)r.push(new Promise(function(n,s){var r=a.nodes[o];t.get(e.senserver+"/clients/"+r.name+"/history").success(function(e){r.status=-1;for(var t in e){var s=e[t];r.status=Math.max(r.status,s.last_status)}console.log("Fetched node status of '"+r.name+"' as "+r.status),n()})}));Promise.all(r).then(n())})};o.then(i,function(e){return Promise.reject(e)}).then(r,function(e){console.log(e)})}]),angular.module("adf.widget.sensummary").service("sensuService",["$q","$http","githubApiUrl",function(e,t,n){return{getCommits:function(s){var a=e.defer(),r=n+s+"/commits?callback=JSON_CALLBACK";return t.jsonp(r).success(function(e){if(e&&e.meta){var t=e.meta.status;300>t?a.resolve(e.data):a.reject(e.data.message)}}).error(function(){a.reject()}),a.promise}}}])}(window);